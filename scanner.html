<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>UCC Camera Scanner</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background-color: black;
      color: white;
      text-align: center;
    }
    #scanner {
      width: 100%;
      margin-top: 20px;
    }
    #feedback {
      font-size: 1.8rem;
      font-weight: bold;
      margin-top: 20px;
      white-space: pre-line;
    }
    #info {
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 1rem;
      text-align: left;
    }
  </style>
</head>
<body>
  <div id="info"></div>
  <div id="scanner"></div>
  <div id="feedback">Scan a Code</div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const type = urlParams.get('type');
    const po = urlParams.get('po');
    const info = document.getElementById("info");
    info.innerHTML = `Type: ${type}<br>P/O: ${po}`;

    const feedback = document.getElementById("feedback");
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxVlbWkVMdyN3Z33kkHJTAU-jSd3ytbU0pSVgn9CUqsgMPUolotJ96LIFKFMGrrywd5DA/exec";

    function showMessage(msg, color) {
      feedback.innerText = msg;
      feedback.style.color = color;
    }

    async function onScanSuccess(decodedText) {
      const code = decodedText.trim();

      // ‚úÖ 20ÏûêÎ¶¨ Ïà´Ïûê ÏïÑÎãàÎ©¥ Invalid
      if (!/^\d{20}$/.test(code)) {
        showMessage("‚ùå\n\nInvalid Code", "red");
        return;
      }

      showMessage("Please wait...", "gray");

      try {
        const url = `${GAS_URL}?code=${encodeURIComponent(code)}&type=${type}&po=${po}`;
        const res = await fetch(url);
        const { status, row, sscc, message } = await res.json();

        let text = "";
        if (status === "‚úì") {
          text = `‚úÖ\n\nSSCC: ${sscc}\n\nRow: ${row}`;
          feedback.style.color = "lime";
        } else if (status === "DUP") {
          text = `üîÅ DUPLICATE\n\nSSCC: ${sscc}\n\nRow: ${row}`;
          feedback.style.color = "orange";
        } else {
          text = "‚ùå\n\nNot Registered";
          feedback.style.color = "red";
        }

        if (message) text += `\n\n${message}`;
        feedback.innerText = text;

      } catch (err) {
        showMessage("‚ùå\n\nConnection Error", "red");
      }
    }

    const html5QrCode = new Html5Qrcode("scanner");
    Html5Qrcode.getCameras().then(devices => {
      if (devices.length) {
        html5QrCode.start(
          { facingMode: "environment" },
          {
            fps: 10,
            qrbox: { width: 250, height: 150 } // Ïúó Î™®ÏÑúÎ¶¨ Í≥†Ï†ï, ÏÑ∏Î°úÎßå Ï§ÑÏûÑ
          },
          onScanSuccess
        );
      } else {
        showMessage("‚ùå No camera found", "red");
      }
    }).catch(err => {
      showMessage("‚ùå Camera Error", "red");
    });
  </script>
</body>
</html>
